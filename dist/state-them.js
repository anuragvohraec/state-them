const e=new Map,t="{{st}}";let i=1;function n(i,...n){const s=document.createElement("template");let o="",r=i.length;for(let e of i)r--,e.trim().endsWith("=")?o+=e+t:o+=0!==r?e+"\x3c!--{{st}}--\x3e \x3c!--{{st}}--\x3e":e;return s.innerHTML=o,e.has(i)||e.set(i,s),{_id:n,templates:i,values:n}}function s(){const e=new DocumentFragment,n=i++;let s=document.createComment(t);s.stid=n;let o=document.createComment(t);o.stid=n,s.endCommentNode=o,e.appendChild(s);let r=document.createTextNode("");return e.appendChild(r),e.appendChild(o),e.startCommentNode=s,e}function o(e,t){let i=e.nextSibling;const n=e.parentNode;for(;i!==e.endCommentNode;){let e=i.nextSibling;n.removeChild(i),i=e}t||(t=document.createTextNode("")),n.insertBefore(t,e.endCommentNode)}function r(e,t){let i=t.referenceNode;for(;i!==e;)i=t.nextNode()}function h(n,a){const{templates:c,values:m,_id:d}=a;if(n.prevTemplates!==c){for(let e of n.childNodes)n.removeChild(e);const t=e.get(c).content.cloneNode(!0);n.appendChild(t)}{const e=m;let a=0,c=document.createNodeIterator(n),d=n;for(;d;){if(d.nodeType===Node.COMMENT_NODE&&d.textContent===t){let t=d._id,n=e[a];if(t!==n){let e;if(d._id=n,d.stid)e=d.stid;else{e=i++,d.stid=e;const t=d.nextSibling.nextSibling;t.stid=e,d.endCommentNode=t}if(n&&n.templates&&n.values){let e=!1;if(n._id?t?._id!==n._id&&(e=!0):e=!0,e){const e=new DocumentFragment;h(e,n),o(d,e),r(d.endCommentNode,c)}}else if(Array.isArray(n)){let e=!1;if(Array.isArray(t)||(t=[],e=!0),e||0===t.length||0===n.length){o(d);let e=new DocumentFragment;for(let t of n){let i=new DocumentFragment;h(i,t);let n=s();n.startCommentNode._id=t._id,o(n.startCommentNode,i),e.appendChild(n)}parent=d.parentNode,parent.insertBefore(e,d.endCommentNode),r(d.endCommentNode,c)}else{let e=d.endCommentNode;c.nextNode(),d=c.nextNode();let i=n.length-t.length,a=d.parentNode,m=0;for(;d!==e;){let t=d,l=t.endCommentNode;if(t._id!==n[m]._id){t._id=n[m]._id;let e=new DocumentFragment;h(e,n[m]),o(t,e)}if(r(l,c),d=c.nextNode(),m++,i<0&&m===n.length){for(;d!==e;)a.removeChild(d),d=c.nextNode();break}if(i>0&&d===e){for(;i>0;){let t=new DocumentFragment;h(t,n[m]);let r=s();r.startCommentNode._id=n[m]._id,o(r.startCommentNode,t),a.insertBefore(r,e),m++,i--}break}}}}else{o(d,new Text(n)),r(d.endCommentNode,c)}}a++}else if(d.nodeType===Node.ELEMENT_NODE){let i=!1,n=d.attributes.length;n>0&&(i=!0);let s=!1;if(d.stAt&&(s=!0,n=Object.keys(d.stAt).length),n>0)for(let o=0;o<n;o++)if(i&&!s){let i=d.attributes[o];if(i.value===t){d.stAt||(d.stAt={});let t=i._id,n=e[a];if(t!==n){if(i._id=e[a],i.name.startsWith(".")){d[i.name.substring(1)]=n,d.removeAttribute(i.name)}else if(i.name.startsWith("@")){const e=i.name.substring(1);t&&d.removeEventListener(e,t),d.addEventListener(e,n),d.removeAttribute(i.name)}else{let e="";n&&(e=n.toString());let t=i.name;if(t.startsWith("?"))if(e){d.removeAttribute(t);let i=t.substring(1);d.setAttribute(i,e)}else{d.removeAttribute(t);let e=t.substring(1);d.removeAttribute(e)}else i.value=e}d.stAt[a]=i}a++}}else if(s){let t=d.stAt[a],i=t._id,n=e[a];if(i!==n){t._id=n;const e=t.name;if(e.startsWith(".")){d[e.substring(1)]=n}else if(e.startsWith("@")){const t=e.substring(1);i&&d.removeEventListener(t,i),d.addEventListener(t,n)}else{let i="";if(n&&(i=n.toString()),e.startsWith("?"))if(i){let t=e.substring(1);d.setAttribute(t,i)}else{let t=e.substring(1);d.removeAttribute(t)}else t.value=i}}a++}}d=c.nextNode()}}n.prevTemplates=c}function a(e,t,i){const n=[];return e.forEach(((e,s)=>{const o=t(e),r=i(e,s,o);r._id=o,n.push(r)})),n}class c{#e;#t;#i={};#n=0;#s;#o={};#r;#h;static search(e,t){let i=t;for(;i;){if(i instanceof m){if(i.machineName===e&&i.machine)return i.machine;if(i.hasMachine(e))return i.getHostedMachine(e)}let t=i.parentNode;t instanceof ShadowRoot&&(t=t.host),i=t}}get name(){return this.#h}constructor({model:e,initState:t,integrateWith:i={}}){if(e)if(this.#e=e,t)this.#t=t;else{let t=Object.keys(e);t.length>0&&(this.#t=t[0])}this.#s=i}get state(){return this.#t}_subscribe(e){let t=++this.#n;return this.#i[t]=e,t}_unsubscribe(e){delete this.#i[e]}onConnection(e,t){if(this.#h=t,this.#r=e,Object.keys(this.#s).length>0)for(let e in this.#s){const t=c.search(e,this.#r);if(!t)throw`${JSON.stringify({ec:1,im:e,he:this.#r.tagName,m:this.#h})}`;const i=i=>{const n=this.#s[e][i];if(n){const e=n[this.#t];e&&this.do(e,t)}};this.#o[e]={machine:t,subscription_id:t._subscribe(i)}}}onDisconnection(){for(let e in this.#o)try{let{machine:t,subscription_id:i}=this.#o[e];t._unsubscribe(i)}catch(e){console.error(e)}}do(e,t){let i=this.#e?.[this.#t]?.[e];if(void 0===i)throw`${JSON.stringify({ec:2,an:e,he:this.#r.tagName,m:this.#h})}`;if(!this[e])throw`${JSON.stringify({ec:3,an:e,he:this.#r.tagName,m:this.#h})}`;if(!this[e](t)){this.#t=i;for(let e in this.#i)try{this.#i[e](i)}catch(e){console.error(e)}}}}class m extends HTMLElement{#h;#a;#c;#m;#d;constructor({machineName:e,hostedMachines:t={}}){super(),this.#h=e,this.#a=t,this.hasAttribute("shadow")?(this.attachShadow({mode:"open"}),this.#c=this.shadowRoot):this.#c=this}get machineName(){return this.#h}hasMachine(e){return!!this.#a&&!!this.#a[e]}getHostedMachine(e){return this.#a?.[e]}get machine(){return this.#m}connectedCallback(){for(let e in this.#a)try{this.#a[e].onConnection(this.#c,e)}catch(e){console.error(e)}if(this.#h){if(this.#m=c.search(this.#h,this),!this.#m)throw`${JSON.stringify({ec:4,he:this.tagName,m:this.#h})}`;try{this.#d=this.#m._subscribe((e=>{this.rebuild(e)}))}catch(e){console.error(e)}}this.rebuild(this.#m?.state)}disconnectedCallback(){this.#m&&this.#m._unsubscribe(this.#d);for(let e in this.#a)try{this.#a[e].onDisconnection()}catch(e){console.error(e)}}rebuild(e){if(!this.build)throw`${JSON.stringify({ec:5,w:this.tagName})}`;h(this.#c,this.build(e,this.#m))}}export{c as StateMachine,m as StateMachineWidget,n as html,h as render,a as repeat};
