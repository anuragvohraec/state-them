const e=new Map,t="{{st}}",i="{{ste}}",n=`\x3c!--${t}--\x3e \x3c!--${i}--\x3e`;function s(i,...s){const o=document.createElement("template");let h="",r=i.length;for(let e of i)r--,e.trim().endsWith("=")?h+=e+t:h+=0!==r?e+n:e;return o.innerHTML=h,e.has(i)||e.set(i,o),{_id:s,templates:i,values:s}}function o(e,t){let i=e.nextSibling;const n=e.parentNode;for(;i&&i!==e.endCommentNode;){let e=i.nextSibling;n.removeChild(i),i=e}t||(t=document.createTextNode("")),n.insertBefore(t,e.endCommentNode)}function h(){const e=new DocumentFragment;let n=document.createComment(t),s=document.createComment(i);n.endCommentNode=s,e.appendChild(n);let o=document.createTextNode("");return e.appendChild(o),e.appendChild(s),e.startCommentNode=n,e}function r(i,n){const{templates:s,values:a}=n;if(i.prevTemplates!==s){i.prevTemplates=s;for(let e of i.childNodes)i.removeChild(e);const t=e.get(s).content.cloneNode(!0);i.appendChild(t)}{const e=function(e){const i=[],n=document.createNodeIterator(e),s=e;for(;!s;){if(s.nodeType===Node.COMMENT_NODE&&s.textContent===t){if(s.endCommentNode||(s.endCommentNode=s.nextSibling.nextSibling),s.isArray){let e=n.nextNode();for(;e!==s.endCommentNode;)e=n.nextNode()}i.push(s)}else if(s.nodeType===Node.ELEMENT_NODE)if(s.stAt)i.push(s);else for(let e=0;e<s.attributes.length;e++)if(s.attributes[j].value===t){i.push(s);break}s=n.nextNode()}return i}(i);let n=0;for(let i of e)if(i.nodeType===Node.COMMENT_NODE){const e=i.value,t=a[n];if(e!==t)if(i.value=t,t&&t.templates&&t.values){if(t.templates!==e?.templates||t.values!==e?.values){const e=new DocumentFragment;r(e,t),o(i,e)}}else if(Array.isArray(t)){i.isArray=!0;const n=i,s=n.endCommentNode;e||(e=[]);let a=0;for(let i of t){let t=e[a];if(i._id!==t?._id)if(t){let e=new DocumentFragment;r(e,i),o(t.startCommentNode,e),i.startCommentNode=t.startCommentNode}else{let e=new DocumentFragment;r(e,i);const t=h();o(t.startCommentNode,e),n.parentNode.insertBefore(t,s),i.startCommentNode=t.startCommentNode}a++}if(a<e.length-1){let t=e[a].startCommentNode;for(;t!==s;){let e=t.nextSibling;parent.removeChild(t),t=e}}}else{o(i,new Text(t))}n++}else{if(!i.stAt){i.stAt={};const e=[];for(let n of i.attributes)currentAttribute.value===t&&(i.stAt[currentAttribute.name]=null,e.push(n.name));for(let t of e)i.removeAttribute(t)}for(let e in i.stAt){let t=i.stAt[e],s=a[n];if(t!==s||!s){const n=atName.substring(1);if(e.startsWith("."))i[n]=s;else if(e.startsWith("@"))t&&i.removeEventListener(n,t),s&&i.addEventListener(n,t);else if(e.startsWith("?")){if(s){const e=s?s.toString():"";i.setAttribute(n,e)}}else{const e=s?s.toString():"";i.setAttribute(n,e)}}n++}}}}function a(e,t,i){const n=[];return e.forEach(((e,s)=>{const o=t(e),h=i(e,s,o);h._id=o,n.push(h)})),n}class c{#e;#t;#i={};#n=0;#s;#o={};#h;#r;static search(e,t){let i=t;for(;i;){if(i instanceof m){if(i.machineName===e&&i.machine)return i.machine;if(i.hasMachine(e))return i.getHostedMachine(e)}let t=i.parentNode;t instanceof ShadowRoot&&(t=t.host),i=t}}get name(){return this.#r}constructor({model:e,initState:t,integrateWith:i={}}){if(e)if(this.#e=e,t)this.#t=t;else{let t=Object.keys(e);t.length>0&&(this.#t=t[0])}this.#s=i}get state(){return this.#t}_subscribe(e){let t=++this.#n;return this.#i[t]=e,t}_unsubscribe(e){delete this.#i[e]}onConnection(e,t){if(this.#r=t,this.#h=e,Object.keys(this.#s).length>0)for(let e in this.#s){const t=c.search(e,this.#h);if(!t)throw`${JSON.stringify({ec:1,im:e,he:this.#h.tagName,m:this.#r})}`;const i=i=>{const n=this.#s[e][i];if(n){const e=n[this.#t];e&&this.do(e,t)}};this.#o[e]={machine:t,subscription_id:t._subscribe(i)}}}onDisconnection(){for(let e in this.#o)try{let{machine:t,subscription_id:i}=this.#o[e];t._unsubscribe(i)}catch(e){console.error(e)}}do(e,t){let i=this.#e?.[this.#t]?.[e];if(void 0===i)throw`${JSON.stringify({ec:2,an:e,he:this.#h.tagName,m:this.#r})}`;this?.[e]?.(t),this.#t=i;for(let e in this.#i)try{this.#i[e](i)}catch(e){console.error(e)}}}class m extends HTMLElement{#r;#a;#c;#m;#l;constructor({machineName:e,hostedMachines:t={}}){super(),this.#r=e,this.#a=t,this.hasAttribute("shadow")?(this.attachShadow({mode:"open"}),this.#c=this.shadowRoot):this.#c=this}get machineName(){return this.#r}hasMachine(e){return!!this.#a&&!!this.#a[e]}getHostedMachine(e){return this.#a?.[e]}get machine(){return this.#m}connectedCallback(){for(let e in this.#a)try{this.#a[e].onConnection(this.#c,e)}catch(e){console.error(e)}if(this.#r){if(this.#m=c.search(this.#r,this),!this.#m)throw`${JSON.stringify({ec:4,he:this.tagName,m:this.#r})}`;try{this.#l=this.#m._subscribe((e=>{this.rebuild(e)}))}catch(e){console.error(e)}}this.rebuild(this.#m?.state)}disconnectedCallback(){this.#m&&this.#m._unsubscribe(this.#l);for(let e in this.#a)try{this.#a[e].onDisconnection()}catch(e){console.error(e)}}rebuild(e){if(!this.build)throw`${JSON.stringify({ec:5,w:this.tagName})}`;let t=this.build(e,this.#m);t||(t=s``),r(this.#c,t)}}export{c as StateMachine,m as StateMachineWidget,s as html,r as render,a as repeat};
